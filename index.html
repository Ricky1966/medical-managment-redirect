<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Auth Redirect Debug (Dev)</title>
  <style>
    body { font-family: sans-serif; padding: 16px; }
    h1 { font-size: 1.2rem; margin: 12px 0; }
    p { margin: 8px 0; }
    button { margin: 8px 8px 0 0; padding: 10px 16px; font-size: 1rem; }
    pre { background: #f0f0f0; padding: 8px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>üîç Debug Deep-Link Params</h1>
  <pre id="out-params">(caricamento‚Ä¶)</pre>

  <div id="error-block" style="display:none;">
    <h1 style="color:#c00">‚ùå Errore di verifica</h1>
    <p id="error-msg"></p>
    <button onclick="location.href='login.html'">
      Torna al login
    </button>
  </div>

  <div id="success-block" style="display:none;">
    <h1>‚ñ∂Ô∏è Deep-link calcolato</h1>
    <pre id="out-deeplink"></pre>
    <button id="btn-go">Apri app con deep-link</button>
  </div>

  <script>
    (function() {
      const url    = new URL(window.location.href);
      // raccogli tutti i parametri da query + fragment
      const qp = [...url.searchParams.entries()];
      const fp = url.hash
        .substring(1)
        .split('&')
        .map(p => p.split('='))
        .filter(([k,v]) => k);
      const all = Object.fromEntries([...qp, ...fp]);

      // stampa parametri raw
      document.getElementById('out-params').textContent =
        JSON.stringify(all, null, 2);

      // se c'√® errore, mostro il blocco error
      if (all.error) {
        document.getElementById('error-msg').textContent =
          all.error_description || all.error;
        document.getElementById('error-block').style.display = 'block';
        return;
      }

      // altrimenti calcolo il deeplink
      let type = all.type;
      if (!type && all.code && all.email) type = 'signup';
      const host = type === 'recovery' ? 'reset-password' : 'login-callback';
      const params = new URLSearchParams(all).toString();
      const deeplink = `io.supabase.flutter://${host}?${params}`;

      document.getElementById('out-deeplink').textContent = deeplink;
      document.getElementById('success-block').style.display = 'block';
      document.getElementById('btn-go')
        .addEventListener('click', () => window.location.href = deeplink);
    })();
  </script>
</body>
</html>
